<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inquiry Dashboard - Eat In Bloom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use environment-provided configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'eat-in-bloom-site';

        // Initialize Authentication
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (!user) return;

            const q = collection(db, 'artifacts', appId, 'public', 'data', 'inquiries');
            // Rule 2: No complex queries (orderBy/limit) - fetch all and handle in memory
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('inquiry-list');
                list.innerHTML = "";
                
                if (snapshot.empty) {
                    list.innerHTML = `<p class="text-center py-10 text-gray-500">No inquiries yet. They will appear here when submitted.</p>`;
                    return;
                }

                // Sort in memory by date (descending)
                const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                docs.forEach(data => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-xl shadow-md border-l-4 border-[#E3B448] mb-4";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-[#3A4750]">${data.name}</h3>
                                <p class="text-sm text-gray-500">${data.email}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${data.createdAt?.toDate().toLocaleDateString() || 'Just now'}</span>
                                <button onclick="deleteInquiry('${data.id}')" class="block text-red-500 text-xs mt-2 hover:underline">Remove</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                            <div><strong>Guests:</strong> ${data.guests}</div>
                            <div><strong>Date:</strong> ${data.date || 'Flexible'}</div>
                        </div>
                        <p class="text-gray-700 bg-gray-50 p-3 rounded italic text-sm">"${data.message}"</p>
                    `;
                    list.appendChild(card);
                });
            }, (error) => {
                console.error("Firestore error:", error);
                const list = document.getElementById('inquiry-list');
                list.innerHTML = `<p class="text-center py-10 text-red-500 font-bold">Error loading inquiries. Please check console for details.</p>`;
            });
        });

        window.deleteInquiry = async (id) => {
            if (confirm("Are you sure you want to remove this inquiry?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inquiries', id));
                } catch (error) {
                    console.error("Error deleting document:", error);
                }
            }
        };
    </script>
</head>
<body class="bg-[#F8F8F8] font-sans p-6">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-serif text-[#3A4750]">Booking Inquiries</h1>
            <a href="index.html" class="text-sm font-bold text-[#E3B448]">Back to Site</a>
        </div>
        
        <div id="inquiry-list" class="space-y-4">
            <p class="text-center py-10 text-gray-400">Loading dashboard...</p>
        </div>
    </div>
</body>
</html>
